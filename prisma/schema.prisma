generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_DATABASE_URL")
}
model User {
  id            String       @id @default(uuid())
  email         String       @unique
  name          String
  password      String?
  profileImage  String?
  isBlock       Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  refreshToken  String?      @default("null")
  role          Role         @default(USER)
  bannerImage   String?
  isVerified    Boolean      @default(false)
  phone         String?
  agencyProfile Agency?
  Booking       Booking[]
  TripPlan      TripPlan[]
  userProfile   UserProfile?
  Wallet        Wallet?
  conversations UserOnConversation[]
  sentConnections ConnectionRequest[] @relation("ReceivedConnections")
  recievedConnections ConnectionRequest[] @relation("SentConnections")
  Message Message[]

  groupMembers GroupMember[]
  createdGroups Group[] @relation("GroupCreator")
}

model UserProfile {
  id           String       @id @default(uuid())
  location     String?
  phone        String?
  itenararyIds String[]
  chatIds      String[]
  createdAt    DateTime     @default(now())
  userId       String       @unique
  feedbacks    Feedbacks[]
  review       Review[]
  user         User         @relation(fields: [userId], references: [id])
  preferences  preference[] @relation("UserPreferences")
}

model preference {
  id    String        @id @default(uuid())
  name  String
  users UserProfile[] @relation("UserPreferences")
}

model UserVerification {
  id         String   @id @default(uuid())
  name       String?
  email      String   @unique
  otp        String   @unique
  otp_expiry DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  password   String?
  role       Role     @default(USER)
  phone      String?
}

model Booking {
  id                    String              @id @default(uuid())
  packageId             String
  userId                String
  travelDate            String    
  peopleCount           Int
  connectiongroupId     String
  totalAmount           Int
  isCancellationAllowed Boolean
  status                BookingStatus       @default(PENDING)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  agencyId              String
  agencyEarning         Float
  commissionRate        Float
  platformEarning       Float
  agency                Agency              @relation(fields: [agencyId], references: [id])
  package               Package             @relation(fields: [packageId], references: [id])
  user                  User                @relation(fields: [userId], references: [id])
  feedbacks             Feedbacks[]
  review                Review[]
  transaction           Transaction[]
  WalletTransaction     WalletTransaction[]
}

model Agency {
  id                String              @id @default(uuid())
  transactionId     String?
  pendingPayouts    Int                 @default(0)
  totalEarnings     Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  status            AgencyStatus        @default(PENDING)
  role              Role                @default(AGENCY)
  description       String?
  userId            String              @unique
  address           String?
  licenseNumber     String?
  ownerName         String?
  websiteUrl        String?
  user              User                @relation(fields: [userId], references: [id])
  rejectionReason   String? @default("null")
  booking           Booking[]
  package           Package[]
  transaction       Transaction[]
  WalletTransaction WalletTransaction[]
  bankDetails       AgencyBankDetails?
  payoutRequests    PayoutRequest[]
}

model Itenerary {
  id            String  @id @default(uuid())
  day           String?
  activities    String?
  meals         String?
  accommodation String?
  packageId     String
  package       Package @relation(fields: [packageId], references: [id])
}

model Package {
  id               String          @id @default(uuid())
  agencyId         String
  description      String?
  destination      String?
  status           PackageStatus   @default(ACTIVE)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  itineraryName    String?
  highlights       String?
  picture          String[]
  transportationId String?         @unique
  duration         Int?
  price            Float
  bookings         Booking[]
  itineraries      Itenerary[]
  agency           Agency          @relation(fields: [agencyId], references: [id])
  transportation   Transportation? @relation(fields: [transportationId], references: [id])
}

model Transportation {
  id           String   @id @default(uuid())
  vehicle      String
  pickup_point String
  drop_point   String
  details      String
  package      Package?
}

model Transaction {
  id              String        @id @default(uuid())
  amount          Int
  initiatedBy     Role          @default(USER)
  paidAt          DateTime?
  agencyId        String
  bookingId       String
  createdAt       DateTime      @default(now())
  currency        String        @default("inr")
  paymentIntentId String
  updatedAt       DateTime      @updatedAt
  status          PaymentStatus @default(PENDING)
  agency          Agency        @relation(fields: [agencyId], references: [id])
  booking         Booking       @relation(fields: [bookingId], references: [id])
}

model Feedbacks {
  id        String      @id @default(uuid())
  userId    String
  rating    String
  comment   String
  bookingId String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  booking   Booking     @relation(fields: [bookingId], references: [id])
  user      UserProfile @relation(fields: [userId], references: [id])
}

model Review {
  id        String      @id @default(uuid())
  userId    String
  ratings   Int
  bookingId String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  booking   Booking     @relation(fields: [bookingId], references: [id])
  user      UserProfile @relation(fields: [userId], references: [id])
}

model TripPlan {
  id           String   @id @default(uuid())
  userId       String
  destination  String
  duration     String
  budget       String
  travelerType String
  hotels       Json
  itinerary    Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  startDate String
  visibility Boolean

}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique
  balance      Float               @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id])
  transactions WalletTransaction[]
}

model WalletTransaction {
  id        String                @id @default(uuid())
  walletId  String
  amount    Float
  type      TransactionType
  createdAt DateTime              @default(now())
  status    PaymentStatus         @default(SUCCEEDED)
  agencyId  String?
  bookingId String?
  category  WalletTransactionType
  agency    Agency?               @relation(fields: [agencyId], references: [id])
  booking   Booking?              @relation(fields: [bookingId], references: [id])
  wallet    Wallet                @relation(fields: [walletId], references: [id])
}

model ConnectionRequest {
  id          String   @id @default(uuid())
  senderId    String
  receiverId  String
  status      ConnectionType @default(PENDING)
  createdAt   DateTime @default(now())
  sender   User @relation("SentConnections", fields: [senderId], references: [id])
  receiver User @relation("ReceivedConnections", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
  @@index([receiverId])
}

model Conversation {
  id         String                @id @default(uuid())
  createdAt  DateTime              @default(now())
  participants      UserOnConversation[]
  messages   Message[]
}

model UserOnConversation {
  userId         String
  conversationId String
  user           User         @relation(fields: [userId], references: [id])
  conversation   Conversation @relation(fields: [conversationId], references: [id])

  @@id([userId, conversationId])
  @@index([conversationId])
}

model Message {
  id             String        @id @default(uuid())
  content        String
  senderId       String
  conversationId String?
  groupId        String? 
  createdAt      DateTime      @default(now())
  sender         User          @relation(fields: [senderId], references: [id])
  conversation   Conversation?  @relation(fields: [conversationId], references: [id])
  group          Group?        @relation(fields: [groupId], references: [id])

  @@index([conversationId])
  @@index([groupId])
  @@index([senderId])    
}
model Group {
  id          String   @id @default(uuid())
  name        String
  avatar      String?
  creatorId   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  members     GroupMember[]
  messages    Message[]
  creator     User          @relation("GroupCreator", fields: [creatorId], references: [id])
}

model GroupMember {
  id        String   @id @default(uuid())
  groupId   String
  userId    String
  role      GroupRole     @default(MEMBER) // ADMIN, MODERATOR, MEMBER
  joinedAt  DateTime @default(now())

  group     Group    @relation(fields: [groupId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  @@unique([groupId, userId])
}
model AgencyBankDetails {
  id                String   @id @default(uuid())
  agencyId          String   @unique
  accountHolderName String
  accountNumber     String
  ifscCode          String
  bankName          String?
  branch             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  agency            Agency   @relation(fields: [agencyId], references: [id])
}

model PayoutRequest {
  id             String          @id @default(uuid())
  agencyId       String
  amount         Float
  status         PayoutStatus    @default(PENDING)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  agency         Agency          @relation(fields: [agencyId], references: [id])
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum GroupRole {
  ADMIN
  MEMBER
}
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum AgencyStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum PackageStatus {
  ACTIVE
  INACTIVE
}

enum Role {
  ADMIN
  USER
  AGENCY
}

enum WalletTransactionType {
  USER_PAYMENT
  ADMIN_CREDIT
  AGENCY_CREDIT
  REFUND
  WITHDRAWAL
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum ConnectionType {
  PENDING
  ACCEPTED
  REJECTED
}